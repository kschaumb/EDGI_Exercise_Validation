---
title: EDGI Exercise Validation Paper Results
author: Katherine Schaumberg
output:
  bookdown::html_document2: default
editor_options: 
  markdown: 
    wrap: 72
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE,  warning = FALSE)
library(expss)
library(bookdown)
library(dplyr)
library(haven)
library(sjmisc)
library(rmarkdown)
library(knitr)
library(psych)
library(ggplot2)
library(ggrepel)
library(wesanderson)
library(tidyr)
library(caret)
load('../data/EDGI_exercise_cleaned.RData') 

exercisers <- EDGI_exercise_cleaned |> 
  filter(ED100k_exercise_icb > 0)
regular_exercisers <- EDGI_exercise_cleaned |> 
  filter(ED100k_exercise_icb == 2)
compulsive_exercisers <- EDGI_exercise_cleaned |> 
  filter(ED100k_ex_compulsive >0)
regular_compulsive_exercisers <- EDGI_exercise_cleaned |> 
  filter (ED100k_ex_compulsive_strict == 1)

```

# Preliminary Aim - Develop a scoring algorithm

The first aim of this paper is to develop a scoring algorithm for a
ED100k exercise items in an ED sample based on theoretical literature
and available ED100k items which captures and defines rates of:

1\. Compulsive Exercise

-   Ever and Regular Compulsive Exercise

-   Duration, Frequency, Age of Onset, and current rates

2\. Exercise Addiction

3\. Excessive Exercise

4\. Compensatory Exercise

5\. A broad definition of Maladaptive Exercise

In the sample

## Scoring

The ED100k included 12 questions regarding maladaptive exercise. The
first question which all participants were asked, inquires as to whether
individuals ever exercised to intentionally control weight and shape
(Q1). Only those who endorsed EVER Exercising to intentionally control
weight or shape were asked to respond to two additional questions which
asked about exercise in more detail, including two questions (Q2, Q3)
about whether individuals ever felt compelled to exercise and whether
they felt uneasy or distressed if unable to exercise. In a third step,
those who reported ever exercising to intentionally control weight and
shape and answered 'Yes' to either Q2 or Q3 were additionally asked
three questions (Q4-Q6) about whether exercise interfered with life
activities or diet, along with questions regarding the onset (Q7),
duration (Q8), and frequency (Q9) of their compulsive exercise, along
with whether they engaged in the behavior currently (Q10) and the last
age at which they engaged in the behavior (Q11). In a separate section,
all participants were asked whether they had 'exercised excessively'
specifically to *compensate* for episodes of binge eating or overeating
(Q12).

During recoding, those (n =
`r sum(EDGI_exercise_cleaned$ED100k_ex_any == 0)`) who reported no to
Q1 - exercise to control shape and weight, were marked as '0' for
follow-up questions. Those who reported that they had engaged in
exercise to for weight and shape control but 'No' to both Q2 & Q3 (n =
`r sum(exercisers$ED100k_ex_compulsive == 0, na.rm = TRUE)`) were marked
as '0' for Q4-Q11.

## 1. Compulsive Exercise

Individuals were classified as compulsive exercisers if they reported
any exercise to intentionally control weight and shape AND either
feeling compelled to exercise or distress if unable to exercise for any
amount of time -- this included
`r frq(EDGI_exercise_cleaned$ED100k_ex_compulsive)[[1]]$valid.prc[[2]]`%
of the US EDGI sample. Amongst those who reported ANY exercise for shape
and weight control and were asked explicitly about compulsive exercise
(not skipped), rates of endorsement for either feeling compelled to
exercise OR feeling distressed when unable to exercise are high
(`r frq(exercisers$ED100k_ex_compulsive)[[1]]$valid.prc[[2]]`%); among
those who reported exercise for shape and weight control 'more often',
endorsement of either feeling compelled to exercise OR feeling
distressed when unable to exercise is
`r frq(regular_exercisers$ED100k_ex_compulsive)[[1]]$valid.prc[[2]]`% --
indicating that these two questions may be unnecessary for defining
compulsive exercise *within* eating disordered samples -- those who
report ever using exercise to intentionally control shape and weight,
particularly if that was reported regularly, almost universally report
either feeling compelled to exercise or feeling distressed when unable
to exercise.

Using a more strict definition of compulsive exercise than having ever
endorsed this behavior, 'regular compulsive exercisers' were defined as
those who endorsed using exercise as a weight control behavior 'more
often', with symptoms lasted least three months in duration.
`r frq(exercisers$ED100k_ex_compulsive_strict_3mo)[[1]]$valid.prc[[2]]`%
of those who reported any exercise to control weight and shape and the
vast majority
(`r frq(regular_exercisers$ED100k_ex_compulsive_strict_3mo)[[1]]$valid.prc[[2]]`%
of individuals who endorsed exercising 'more often' met this strict
definition, highlighting that (1) most individuals with eating disorders
who report compulsive exercise are engaging in this behaivor regularly,
and (2) further indicating high convergent validity of the first
question regarding regular exercise to control weight and subsequent
questions which further define compulsive exercise. Specifically,
individuals eating disorders who endorse using exercise to intentionally
control weight 'more often' are indeed engaging in this behavior for a
substantive period of time (\> 3 months; a time period of equivalent to
diagnostic levels of other intentional weight control behaviors).
Further exploration of duration of compulsive exercise indicated that
the majority of individuals in the sample reported compulsive exercise
lasting \> 1 year (see @fig-durplot).


```{r}
#| label: fig-durplot
#| fig-cap: "Duration of Compulsive Exercise Reported in EDGI US sample"


ex_dur_frqs <- frq(EDGI_exercise_cleaned$ED100k_ex_dur)[[1]] %>% 
  filter(!is.na(val))

ex_dur_frqs$text_y <- 100 - (cumsum(ex_dur_frqs$valid.prc) - ex_dur_frqs$valid.prc/2)

ggplot(ex_dur_frqs, aes(x = '', y = frq, fill = reorder(label, text_y))) +
  geom_bar(width = 1, stat = 'identity') + 
  coord_polar('y', start = 0) + 
  theme(axis.text.x = element_blank(), panel.border = element_blank(), panel.grid = element_blank())+
  geom_text(aes(label = paste0(round(valid.prc,0), '%')), 
            position = position_stack(vjust = 0.8)) +
  theme(axis.title = element_blank(), legend.title = element_blank())  +
  scale_fill_discrete(breaks = c('No compulsive exercise', 'Less than 1 month', '1 to 2 months', '3 to 5 months', '6-12 months', 'More than 1 year')) 
 
  
```
Regarding age, for those engaging in compulsive exercise, the reported
median age at the last time they engaged in this behavior was
`r median(compulsive_exercisers$ex_age_last, na.rm = TRUE)` (current
median age = `r median(compulsive_exercisers$age, na.rm = TRUE)`. About
half
(`r round(sum(is.na(compulsive_exercisers$ex_age_last))*100/nrow(compulsive_exercisers),1)`%)
of the sample reporting compulsive exercise did not report age
of last compulsive exercise -- potentially indicative of ongoing
engagement in this symptom. Median age of first engaging in compulsive
exercise in the sample who reported this behavior regularly was
`r median(compulsive_exercisers$ex_age, na.rm = TRUE)` years old.
`r frq(EDGI_exercise_cleaned$ED100k_ex_compulsive_current)[[1]]$valid.prc[[2]]`%
of the overall sample and
`r frq(regular_compulsive_exercisers$ED100k_ex_compulsive_current)[[1]]$valid.prc[[2]]`%
of those reporting regular compulsive exercise reported that compulsive exercise was an
*ongoing* eating disorder symptom.

## 2. Exercise Addiction

Individuals with any compulsive exercise symptoms were also asked whether this interfered with their life in a series of 3 questions --
whether it caused them to change eating habits, decline opportunities to
be with friends, or whether they exercised despite illness or injury.
Overall, `r frq(EDGI_exercise_cleaned$ED100k_ex_interfere)[[1]]$valid.prc[[2]]`%
of individuals in the overall sample reported at least one of these three
life interfering symptoms. Among only those reporting exercising for weight control 'more often' in Q1, rates of endorsement of life interfering symptoms
were `r frq(regular_exercisers$ED100k_ex_interfere)[[1]]$valid.prc[[2]]`%,
providing further validation for the first item assessing frequency of
exercise to control weight and shape, and indicating that the vast
majority of individuals with eating disorders who reporting regular exercise for weight loss to control weight and shape have also experienced life interfering sequellae of
this behavior. Further, in both the overall sample as well as those with
regular exercise for weight control, the modal number of exercise
interference items was all 3.

Exercise Addiction was defined in the ED100k as engaging in regular
('more often') exercise for weight or shape control coupled with feeling
compelled to exercise or distressed if unable to exercise, which lasted
for at least 3 months and included at least one life interfering
symptom.`r frq(EDGI_exercise_cleaned$ED100k_ex_addictive)[[1]]$valid.prc[[2]]`%
of individuals in the overall sample,
`r frq(exercisers$ED100k_ex_addictive)[[1]]$valid.prc[[2]]`% of those
reporting any exercise for weight control, and almost all of those who
reported exercising for weight control 'more often'
(`r frq(regular_exercisers$ED100k_ex_addictive)[[1]]$valid.prc[[2]]`%)
met this criteria.

## 4. Excessive Exercise

Excessive exercise was defined as compulsive exercise occurring for at
least one month, every day or nearly ever day. Among the whole sample,
rates are
`r frq(EDGI_exercise_cleaned$ED100k_ex_excessive)[[1]]$valid.prc[[2]]`,
and among the subsample who reported exercising for weight loss 'more
often',
`r frq(regular_exercisers$ED100k_ex_excessive)[[1]]$valid.prc[[2]]`% met
criteria for this exercise being excessive. While the majority of
individuals reporting regular exercise for weight and shape control at
some point (along with the highly overlapping samples meeting
'compulsive exercise' and 'exercise addiction') also report exercise
that occurs with high frequency (nearly every day), this is not as
universal as other symptoms that were assessed.

## 5. Compensatory Exercise

All participants were asked about compensatory exercise,
with `r frq(EDGI_exercise_cleaned$be_icb___5)[[1]]$valid.prc[[2]]`% of
the sample reporting compensatory exercise. Among those with regular
exercise, rates were somehwat higher
(`r frq(regular_exercisers$be_icb___5)[[1]]$valid.prc[[2]]`). Overall,
compensatory exercise was common, but somewhat less prevlant than other
maladaptive exercise behaviors.

## Broad Maladaptive Exercise

A broad 'Maladaptive Exercise' variable was the final exercise
definition that was derived, which included individuals who reported
any compulsive exercise OR any compensatory exercise. Among the full
sample,
`r frq(EDGI_exercise_cleaned$ED100k_ex_maladaptive_1)[[1]]$valid.prc[[2]]`%
of individuals met criteria for this broad definition.

# Convergent Validity

## Exercise History Definitions

When examining overlap in compensatory and compulsive exercise, the vast
majority of individuals endorsing compensatory exercise also endorsed
compulsive exercise, with very few indivdiuals endorsing compensatory
exercise without also endorsing compulsive exercise

```{r}
#create a table of the two variables of interest
ct <- table(EDGI_exercise_cleaned$ED100k_ex_compulsive, EDGI_exercise_cleaned$ED100k_ex_compensatory) 

ex_row_percents <- prop.table (ct, 1)

ex_row_percents <- as.data.frame(ex_row_percents)  |> 
 rename(`Compulsive Exercise` = Var1) |> 
 rename(`Compensatory Exercise` = Var2)  |> 
filter(`Compensatory Exercise` == 1)

ggplot(ex_row_percents, aes( x = `Compulsive Exercise`, y = Freq*100, fill = `Compulsive Exercise` )) + 
  geom_col()+
  labs(title = 'Compensatory vs. Compulsive Exercise', x = 'Compulsive Exercise', y = 'Percent Endorsing Compensatory Exercise') + 
  scale_x_discrete(labels = c('No', 'Yes')) +
  theme(legend.position = 'none') +
  geom_text(aes(x  = `Compulsive Exercise`, y = (Freq*100)-3, label = paste0(round(Freq*100,2),'%'), size = 3))
  

```

```{r}
#create a table of the two variables of interest
ct2 <- table(EDGI_exercise_cleaned$ED100k_ex_compensatory, EDGI_exercise_cleaned$ED100k_ex_compulsive)

ex_row_percents <- prop.table (ct2, 1)

ex_row_percents <- as.data.frame(ex_row_percents) |> 
 rename(`Compensatory Exercise` = Var1) |> 
 rename(`Compulsive Exercise` = Var2) |> 
filter(`Compulsive Exercise` == 1)

ggplot(ex_row_percents, aes( x = `Compensatory Exercise`, y = Freq*100, fill = `Compensatory Exercise` )) + 
  geom_col()+
  labs(title = 'Compulsive vs. Compensatory Exercise', x = 'Compensatory Exercise', y = 'Percent Endorsing Compulsive Exercise') + 
  scale_x_discrete(labels = c('No', 'Yes')) +
  theme(legend.position = 'none') +
  geom_text(aes(x  = `Compensatory Exercise`, y = (Freq*100)-3, label = paste0(round(Freq*100,2),'%'), size = 3))
# change colour
  
```

```{r}
confusionMatrix(as.factor(EDGI_exercise_cleaned$ED100k_ex_compulsive), as.factor(EDGI_exercise_cleaned$ED100k_ex_compensatory), positive = '1')
```

## Current Exercise

```{r}
# Insert ggplots here showing association between current exercise (ED100k), CET total and subscale scores *mean + SD, CET clinical cutoff, and EDEQ item

Current_Exercise <- EDGI_exercise_cleaned |> 
  select(record_id, cet_total_weighted_sum, cet_mood, cet_enjoy, cet_avoid, cet_rigid, cet_wtcontrol, cet_clinical, edeq_ex_driven_freq_28, ED100k_exercise_current)  |>  filter(!is.na(ED100k_exercise_current)) |> 
  mutate(cet_total_std = scale(cet_total_weighted_sum),
         cet_mood_std = scale(cet_mood),
         cet_enjoy_std = scale(cet_enjoy), 
         cet_avoid_std = scale (cet_avoid), 
         cet_rigid_std = scale (cet_rigid),
         cet_wtcontrol_std = scale(cet_wtcontrol))

  # standardize outcome variables
Current_Exercise <- Current_Exercise |> pivot_longer(cols = c(cet_total_std:cet_wtcontrol_std), names_to = 'variable', values_to = 'val') # pivot longer with current exercise as one column, variable name as second column, value as third
  # rename current maladaptive exercise 
  

median_stds <- Current_Exercise |> 
  group_by (ED100k_exercise_current, variable) |> 
  summarize (med_val = median(val, na.rm = TRUE))

cet_total_plot <- ggplot(Current_Exercise, aes(x = as.factor(ED100k_exercise_current), y = val, color = as.factor(ED100k_exercise_current))) +
  facet_wrap(~variable)+
  geom_jitter(size = 0.3) +
  geom_boxplot(alpha = 0.5, color= 'black') +
  scale_x_discrete(labels = c('No Hx', 'Hx only', 'Current')) +
  labs(title = 'Median CET standardized scores based on Driven Exercise History (ED100k)', x = 'Current Driven Exercise [ED100k]', y = 'CET Standardized Score') + 
  theme(legend.position = 'none') +
  geom_text(data = median_stds, aes(x = as.factor(ED100k_exercise_current), y = med_val + 0.3, label = round(med_val, 1)), size = 3, color = 'black', fontface ='bold')


cet_total_plot

```

## Proportion meeting CET Clinical Cutoff based on Driven Exercise History

```{r}

ct3 <- table(EDGI_exercise_cleaned$ED100k_exercise_current, EDGI_exercise_cleaned$cet_clinical)
ex_current_cet <- prop.table (ct3, 1)
ex_current_cet <- as.data.frame(ex_current_cet) |> 
 rename(`Current Driven Exercise [ED100k]` = Var1) |> 
 rename(`CET Clinical Met` = Var2)   |> 
 filter (`CET Clinical Met` == 1)

ggplot(ex_current_cet, aes( x = `Current Driven Exercise [ED100k]`, y = Freq*100, fill = `Current Driven Exercise [ED100k]` )) + 
  geom_col()+
  labs(title = 'ED100k Drive Exercise vs Clinical CET Cutoff', x = 'Driven Exercise Endorsed [ED100k]', y = 'Percent Meeting CET Cutoff') + 
  scale_x_discrete(labels = c('No History', 'History, Not Current', 'Current')) +
  theme(legend.position = 'none') +
  geom_text(aes(x  = `Current Driven Exercise [ED100k]`, y = (Freq*100)-3, label = paste0(round(Freq*100,2),'%'), size = 3))
# change colour
```

### Sensitivity and Specificity of Current Driven Exercise on ED100k for CET Clinical

```{r}
EDGI_exercise_cleaned$ED100k_exercise_current_d <- as.factor(if_else(EDGI_exercise_cleaned$ED100k_exercise_current == 2, 1, 0))

EDGI_exercise_cleaned$cet_clinical <- as.factor(EDGI_exercise_cleaned$cet_clinical)

confusionMatrix(EDGI_exercise_cleaned$ED100k_exercise_current_d, EDGI_exercise_cleaned$cet_clinical, positive = '1') #confusion matrix with ED100k exercise current as prediction and CET clinical as actual

```

## Number of Days in the Past 28 reported Driven Exercise based on Driven Exercise History

```{r}

mean_edeq_ex <- EDGI_exercise_cleaned|> 
  group_by (ED100k_exercise_current) |> 
  filter(!is.na(ED100k_exercise_current)) |> 
  summarize (mean_edeq_ex = mean(edeq_ex_driven_freq_28, na.rm = TRUE))

ggplot(mean_edeq_ex, aes( x = as.factor(ED100k_exercise_current), y = mean_edeq_ex))  +
  geom_point()+
  geom_boxplot(data = EDGI_exercise_cleaned, aes( x = as.factor(ED100k_exercise_current), y = edeq_ex_driven_freq_28, fill = as.factor(ED100k_exercise_current))) +
  labs(title = 'ED100k Drive Exercise vs EDEQ Driven Exercise Frequency (Past 28 days)', x = 'Driven Exercise Endorsed [ED100k]', y = 'Number of Driven Exercise Episodes in Past 28 days [EDEQ]') + 
  scale_x_discrete(labels = c('No History', 'History, Not Current', 'Current')) +
  theme(legend.position = 'none') +
  geom_text(data = mean_edeq_ex, aes(x  = ED100k_exercise_current+1.2, y = mean_edeq_ex+3, label = paste0('M =', round(mean_edeq_ex,2)), size = 3))
```

# Discriminant Validity

## Perfectionism and OCD Symptoms

# Prevalence Across Diagnostic Groups

```{r, results = 'hide'}
# Below makes the 5 case status diagnosis groups
as.data.frame(table(EDGI_exercise_cleaned[c('an_case', 'bn_case', 'bed_case')])) |>
  mutate (prop = round(Freq/sum(Freq)*100, 2)) |> 
  filter (Freq != 0) 
#Make case heirarcy and recode restrictive and binge spectrum mixed cases
EDGI_exercise_cleaned <- EDGI_exercise_cleaned |> 
  mutate (case_status = case_when(an_case == 1 & bn_case == 0 & bed_case == 0 ~ 'AN',
                                   an_case == 0 & bn_case == 1 & bed_case == 0 ~ 'BN',
                                   an_case == 0 & bn_case == 0 & bed_case == 1 ~ 'BED', 
                                   an_case == 1 & (bn_case == 1 | bed_case == 1) ~ 'AN Mixed',
                                   an_case == 0 & bn_case ==1 & bed_case ==1 ~ 'BN-BED Mixed' )) |> 
  mutate (case_heirarchy = case_when (an_case == 1 ~ 'AN', 
                                      bn_case == 1 ~ 'BN', 
                                      bed_case == 1 ~ 'BED'))
```

```{r}
ct <- table(EDGI_exercise_cleaned$case_status, EDGI_exercise_cleaned$ED100k_ex_compulsive)

dx_row_percents <- prop.table (ct, 1)

dx_row_percents <- as.data.frame(dx_row_percents) |> 
 rename(`Diagnosis Group` = Var1) |> 
 rename(`History of Any Compulsive Exercise` =Var2) 

ggplot(dx_row_percents, aes( x = `History of Any Compulsive Exercise`, y = Freq*100, fill = `Diagnosis Group` )) + 
  geom_col()+
  facet_wrap (~ `Diagnosis Group`) +
  labs(title = 'Percentages by Diagnosis Group and History of Any Compulsive Exercise', x = 'History of Any Compulsive Exercise', y = 'Percentage (within Diagnosis Group)') + 
  scale_x_discrete(labels = c('No', 'Yes')) +
    theme(legend.position = 'none') +
    geom_text(aes(x  = `History of Any Compulsive Exercise`, y = (Freq*100)-5, label = paste0(round(Freq*100,2),'%'), size = 3))

```

History of Compulsive Exercise was reported most frequently in the AN,
AN-Mixed Diagnosis, and BN groups, around 60% in each of these
diagnostic groups reporting history of regular engagment. Compulsive
exercise was also reported in half of those with BN-BED (50%) and a
portion (20%) of those with BED.

```{r}
ct <- table(EDGI_exercise_cleaned$case_status, EDGI_exercise_cleaned$ED100k_ex_compulsive_strict_3mo)

dx_row_percents <- prop.table (ct, 1)

dx_row_percents <- as.data.frame(dx_row_percents) |> 
 rename(`Diagnosis Group` = Var1) |> 
 rename(`History of Regular Compulsive Exercise` =Var2) 

ggplot(dx_row_percents, aes( x = `History of Regular Compulsive Exercise`, y = Freq*100, fill = `Diagnosis Group` )) + 
  geom_col()+
  facet_wrap (~ `Diagnosis Group`) +
  labs(title = 'Percentages by Diagnosis Group and History of Regular Compulsive Exercise', x = 'History of Regular Compulsive Exercise', y = 'Percentage (within Diagnosis Group)') + 
  scale_x_discrete(labels = c('No', 'Yes')) +
    theme(legend.position = 'none') +
    geom_text(aes(x  = `History of Regular Compulsive Exercise`, y = (Freq*100)-5, label = paste0(round(Freq*100,2),'%'), size = 3))

```

```{r}
ct <- table(EDGI_exercise_cleaned$case_status, EDGI_exercise_cleaned$ED100k_ex_addictive)

dx_row_percents <- prop.table (ct, 1)

dx_row_percents <- as.data.frame(dx_row_percents) |> 
 rename(`Diagnosis Group` = Var1) |> 
 rename(`History of Exercise Addiction` =Var2) 

ggplot(dx_row_percents, aes( x = `History of Exercise Addiction`, y = Freq*100, fill = `Diagnosis Group` )) + 
  geom_col()+
  facet_wrap (~ `Diagnosis Group`) +
  labs(title = 'Percentages by Diagnosis Group and History of Exercise Addiction', x = 'History of Exercise Addiction', y = 'Percentage (within Diagnosis Group)') + 
  scale_x_discrete(labels = c('No', 'Yes')) +
    theme(legend.position = 'none') +
    geom_text(aes(x  = `History of Exercise Addiction`, y = (Freq*100)-5, label = paste0(round(Freq*100,2),'%'), size = 3))

```

```{r}
ct <- table(EDGI_exercise_cleaned$case_status, EDGI_exercise_cleaned$ED100k_ex_excessive)

ct_tab <- as.data.frame(ct) %>% 
  pivot_wider(names_from = Var2, values_from = Freq) 

dx_row_percents <- prop.table (ct, 1)

dx_row_percents <- as.data.frame(dx_row_percents) |> 
 rename(`Diagnosis Group` = Var1) |> 
 rename(`History of Excessive Exercise` =Var2) 

ggplot(dx_row_percents, aes( x = `History of Excessive Exercise`, y = Freq*100, fill = `Diagnosis Group` )) + 
  geom_col()+
  facet_wrap (~ `Diagnosis Group`) +
  labs(title = 'Percentages by Diagnosis Group and History of Excessive Exercise', x = 'History of Excessive Exercise', y = 'Percentage (within Diagnosis Group)') + 
  scale_x_discrete(labels = c('No', 'Yes')) +
    theme(legend.position = 'none') +
    geom_text(aes(x  = `History of Excessive Exercise`, y = (Freq*100)-5, label = paste0(round(Freq*100,2),'%'), size = 3))

```

```{r}
ct <- table(EDGI_exercise_cleaned$case_status, EDGI_exercise_cleaned$ED100k_ex_compensatory)

ct_tab <- as.data.frame(ct) %>% 
  pivot_wider(names_from = Var2, values_from = Freq) 

dx_row_percents <- prop.table (ct, 1)

dx_row_percents <- as.data.frame(dx_row_percents) |> 
 rename(`Diagnosis Group` = Var1) |> 
 rename(`History of Compensatory Exercise` =Var2) 

ggplot(dx_row_percents, aes( x = `History of Compensatory Exercise`, y = Freq*100, fill = `Diagnosis Group` )) + 
  geom_col()+
  facet_wrap (~ `Diagnosis Group`) +
  labs(title = 'Percentages by Diagnosis Group and History of Compensatory Exercise', x = 'History of Compensatory Exercise', y = 'Percentage (within Diagnosis Group)') + 
  scale_x_discrete(labels = c('No', 'Yes')) +
    theme(legend.position = 'none') +
    geom_text(aes(x  = `History of Compensatory Exercise`, y = (Freq*100)-5, label = paste0(round(Freq*100,2),'%'), size = 3))

```

# Associations with Illness History

## Associations with Binge Eating, Purging, and Fasting

### Historical

```{r}
ED_Behave<- as.data.frame(EDGI_exercise_cleaned$record_id)

ED_Behave$fasting <- if_else(EDGI_exercise_cleaned$ED100k_fasting_icb == 2, 1, 0)
ED_Behave$vomitting <- if_else(EDGI_exercise_cleaned$ED100k_vomit_icb == 2, 1, 0)
ED_Behave$binge_eating <- EDGI_exercise_cleaned$ED100k_binge
ED_Behave$exercise <- EDGI_exercise_cleaned$ED100k_ex_compulsive

ED_Behave <- ED_Behave |> pivot_longer(cols = c('fasting', 'vomitting', 'binge_eating'), names_to = 'behavior')

behave_x <- ED_Behave |> 
  select(c(2:4)) |> 
  group_by(exercise, behavior, value) |> 
  summarise(n = n())  |> 
  filter(!is.na(exercise))

ggplot(behave_x, aes (x = as.factor(exercise), y = n, fill = as.factor(value))) +
  geom_col() +
  facet_wrap (~behavior)
```

```{r}
behave_props <- behave_x |> 
  group_by(behavior, exercise) |> 
  mutate(prop = n/sum(n)) |> 
  ungroup()
  

ggplot(behave_props, aes (x = as.factor(exercise), y = prop*100, fill = as.factor(value))) +
  geom_col() +
  facet_wrap (~behavior)  
  
```

### Current

```{r}
ED_Behave_Hx <- as.data.frame(EDGI_exercise_cleaned$record_id)

ED_Behave_Hx$lax_current <- EDGI_exercise_cleaned$lax_current_1
ED_Behave_Hx$vom_current <-  EDGI_exercise_cleaned$vom_current_1
ED_Behave_Hx$binge_current <- EDGI_exercise_cleaned$binge_current_1
ED_Behave_Hx$ex_current <- EDGI_exercise_cleaned$ED100k_exercise_current

ED_Behave_Hx <- ED_Behave_Hx |> pivot_longer(cols = c('lax_current', 'vom_current', 'binge_current'), names_to = 'behavior')

behave_hx <- ED_Behave_Hx |> 
  select(c(2:4)) |> 
  group_by(ex_current, behavior, value) |> 
  summarise(n = n())  |> 
  drop_na()  

ggplot(behave_hx, aes (x = as.factor(ex_current), y = n, fill = as.factor(value))) +
  geom_col() +
  facet_wrap (~behavior)

behave_hx_props <- behave_hx |> 
  group_by(behavior, ex_current) |> 
  mutate(prop = n/sum(n)) |> 
  ungroup()
  

ggplot(behave_hx_props, aes (x = as.factor(ex_current), y = prop*100, fill = as.factor(value))) +
  geom_col() +
  facet_wrap (~behavior)  
```
